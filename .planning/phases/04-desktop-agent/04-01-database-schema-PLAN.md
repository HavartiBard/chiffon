---
phase: 04-desktop-agent
plan: 01
type: execute
wave: 1
depends_on: ["phase-03"]
files_modified:
  - migrations/alembic/versions/004_desktop_agent_resources.py
  - src/common/models.py
autonomous: true
must_haves:
  truths:
    - "Agent heartbeat messages include resource metrics (CPU, GPU, load averages)"
    - "Orchestrator persists resource metrics to database for each heartbeat"
    - "Orchestrator can query agent capacity by GPU VRAM and CPU cores available"
  artifacts:
    - path: migrations/alembic/versions/004_desktop_agent_resources.py
      provides: "Schema migration adding resource_metrics JSON column to agent_registry"
      contains: "ALTER TABLE agent_registry ADD COLUMN resource_metrics JSON DEFAULT '{}';"
    - path: src/common/models.py
      provides: "AgentRegistry model with resource_metrics field"
      contains: "resource_metrics = Column(JSON, default=dict, nullable=False)"
  key_links:
    - from: "Agent.send_heartbeat()"
      to: "StatusUpdate.resources"
      via: "Resource metrics collected in dict"
    - from: "StatusUpdate.resources"
      to: "agent_registry.resource_metrics"
      via: "Orchestrator handler saves metrics to DB"
---

<objective>
Add resource metrics persistence to database schema. This enables the orchestrator to store and query agent capacity (GPU VRAM, CPU cores available) for intelligent work routing.

Purpose: Phase 3 agents report status via heartbeats, but metrics are not persisted. Phase 4 requires metrics storage for capacity-aware scheduling.

Output: Alembic migration + updated ORM model. No code changes to agents or orchestrator yet (those are Plans 02-04).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-desktop-agent/04-CONTEXT.md
@.planning/phases/04-desktop-agent/04-RESEARCH.md

## Schema Context

Current agent_registry table (from Phase 3, 03-03-agent-router):
- agent_id (UUID, PK)
- agent_type (string: orchestrator, infra, desktop, code, research)
- pool_name (string, for grouping agents)
- capabilities (JSON array)
- status (string: online, offline, busy)
- last_heartbeat_at (datetime)
- performance_score (float)

Phase 4 addition:
- resource_metrics (JSON, for CPU/GPU metrics)

## Data Format Reference (from Research)

StatusUpdate.resources dict structure (from BaseAgent heartbeat):
```python
{
    "cpu_percent": float,              # Current CPU % (0-100)
    "cpu_cores_physical": int,         # Total physical cores
    "cpu_cores_available": int,        # Estimated available cores
    "cpu_load_1min": float,            # 1-min load average
    "cpu_load_5min": float,            # 5-min load average
    "memory_percent": float,           # RAM % (0-100)
    "memory_available_gb": float,      # Available RAM in GB
    "gpu_vram_total_gb": float,        # GPU VRAM total
    "gpu_vram_available_gb": float,    # GPU VRAM free
    "gpu_type": "nvidia|amd|intel|none"
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alembic migration (004_desktop_agent_resources.py)</name>
  <files>migrations/alembic/versions/004_desktop_agent_resources.py</files>
  <action>
Create Alembic migration file that adds resource_metrics column to agent_registry table.

Migration should:
1. Add resource_metrics column as JSON with default empty dict `{}`: `ALTER TABLE agent_registry ADD COLUMN resource_metrics JSON DEFAULT '{}' NOT NULL;`
2. Create GIN index on resource_metrics for efficient JSON queries: `CREATE INDEX idx_agent_registry_resource_metrics ON agent_registry USING GIN (resource_metrics);`
3. Down migration: Drop index, then drop column
4. Use standard Alembic structure with op.add_column() and op.create_index()

File should be located at: migrations/alembic/versions/004_desktop_agent_resources.py

Alembic naming convention: revision_id should follow existing migrations (check for 003_* to get next number).

Use PostgreSQL JSON type (not JSONB for now, keep consistent with existing schema if already using JSON elsewhere).

Example structure (adapt to actual migration numbers):
- Revision (auto-generated by alembic)
- Down revision points to previous migration
- Tables and indexes exactly as specified above
  </action>
  <verify>
Run: `cd /home/james/Projects/chiffon && alembic current` (shows previous migration)
Run: `alembic upgrade head` (applies migration)
Run: `psql -d chiffon -c "\d agent_registry"` (verify column exists with type JSON)
Run: `psql -d chiffon -c "\di" | grep idx_agent_registry_resource_metrics` (verify index exists)
  </verify>
  <done>
Alembic migration file created and applied. PostgreSQL agent_registry table now has resource_metrics JSON column with default {} and GIN index for queries. No errors on upgrade.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AgentRegistry model with resource_metrics field</name>
  <files>src/common/models.py</files>
  <action>
Update AgentRegistry Pydantic model in src/common/models.py to include resource_metrics field.

Changes needed:
1. Add field: `resource_metrics = Column(JSON, default=dict, nullable=False)` to AgentRegistry class definition
2. Add to __tablename__ "agent_registry" class (should already exist from Phase 3-03)
3. Ensure field is optional in Pydantic model for reads (agents may not report metrics initially): Add to model with default_factory=dict
4. Example: `resource_metrics: dict[str, Any] = Field(default_factory=dict, description="Current resource metrics from heartbeat")`

Verify imports:
- `from sqlalchemy import JSON` (already imported)
- `from typing import Any` (already imported)
- `from sqlalchemy.orm import declarative_base` (for Base reference)

Do NOT:
- Break existing fields
- Change agent_id or other existing columns
- Rename or remove any Phase 3 fields

Place field after last_heartbeat_at for logical grouping (temporal info together).
  </action>
  <verify>
Run: `python -c "from src.common.models import AgentRegistry; print(AgentRegistry.__table__.columns.keys())"` (verify resource_metrics column exists in model)
Run: `python -c "from src.common.models import AgentRegistry; ar = AgentRegistry(agent_id='test', resource_metrics={'cpu_percent': 50.0}); print(ar.resource_metrics)"` (verify field is settable)
  </verify>
  <done>
AgentRegistry model updated. resource_metrics field is part of schema. Model can be instantiated with resource metrics. No import errors.
  </done>
</task>

</tasks>

<verification>
1. Database migration applies without errors
2. agent_registry table has resource_metrics JSON column
3. GIN index on resource_metrics exists (enables JSON queries later)
4. AgentRegistry ORM model reflects schema (SQLAlchemy can read/write column)
5. Backward compatibility: existing agents without resource_metrics still work (default {})
</verification>

<success_criteria>
- Alembic migration file created and ready to apply
- AgentRegistry model updated with resource_metrics field
- No breaking changes to existing agent registry functionality
- Database schema supports JSON queries on metrics (via GIN index)
- Ready for Plan 02 (agents start populating resource_metrics)
</success_criteria>

<output>
After completion, create `.planning/phases/04-desktop-agent/04-01-SUMMARY.md` with:
- Migration revision ID applied
- AgentRegistry model changes
- Backward compatibility notes
- Ready-for-Plan-02 status
</output>
