id: komodo-deployment
goal: Generate Ansible roles to deploy Komodo multi-host Docker management on Proxmox LXC with Periphery agents on Unraid and spraycheese
source: obsidian:projects/homelab-infra/komodo-deployment

description: |
  Deploy Komodo (https://github.com/moghtech/komodo) as the central Docker management
  plane for the homelab. Target repo: homelab-infra/ansible.

  Komodo architecture:
  - Core listens on port 9120 (HTTP), connects to FerretDB (MongoDB adapter over Postgres)
  - Periphery listens on port 8120 (HTTPS self-signed), mounts /var/run/docker.sock and /proc
  - Core authenticates to Periphery using a shared KOMODO_PASSKEY/PERIPHERY_PASSKEYS

  Host placement:
  - komodo-core: new Proxmox LXC at 192.168.20.62 (Ubuntu 24.04, Docker installed, has Python)
  - komodo-periphery: Unraid at 192.168.20.14 (no Python — must use ansible.builtin.raw)
  - komodo-periphery: spraycheese at 192.168.20.50 (SSH, has Python)

  Files to generate:

  1. ansible/roles/komodo-core/defaults/main.yml
     - komodo_core_image: ghcr.io/moghtech/komodo-core:latest
     - komodo_ferretdb_image: ghcr.io/ferretdb/ferretdb:latest
     - komodo_postgres_image: ghcr.io/ferretdb/postgres-documentdb:latest
     - komodo_core_port: 9120
     - komodo_appdata_dir: /opt/komodo
     - komodo_stack_dir: /opt/komodo/stack
     - komodo_backups_dir: /opt/komodo/backups
     - komodo_host: https://komodo.klsll.com
     - komodo_title: Komodo
     - komodo_monitoring_interval: 15-sec
     - komodo_resource_poll_interval: 1-hr
     - komodo_db_username: komodo
     - komodo_db_password: "{{ vault_komodo_db_password }}"
     - komodo_passkey: "{{ vault_komodo_passkey }}"
     - komodo_admin_username: admin
     - komodo_admin_password: "{{ vault_komodo_admin_password }}"
     - komodo_first_server: "https://192.168.20.14:8120"
     - komodo_first_server_name: Unraid

  2. ansible/roles/komodo-core/tasks/main.yml
     - Create dirs: komodo_appdata_dir, komodo_stack_dir, komodo_backups_dir
     - Template docker-compose.yml.j2 to komodo_stack_dir/docker-compose.yml
     - Template compose.env.j2 to komodo_stack_dir/compose.env
     - docker compose pull (in komodo_stack_dir)
     - docker compose up -d (in komodo_stack_dir)
     - Health check: curl http://localhost:9120/auth/config until 200 (10 attempts, 5s sleep)
     - Show last 20 lines of core container logs

  3. ansible/roles/komodo-core/templates/docker-compose.yml.j2
     Services: postgres, ferretdb, core (no local periphery on the LXC — managed hosts are remote)
     - postgres: image={{ komodo_postgres_image }}, label komodo.skip, volume postgres-data
     - ferretdb: depends_on postgres, image={{ komodo_ferretdb_image }}, label komodo.skip
     - core: image={{ komodo_core_image }}, label komodo.skip, port {{ komodo_core_port }}:9120
       env_file: ./compose.env, volumes: backups:/backups
     Named volumes: postgres-data, ferretdb-state

  4. ansible/roles/komodo-core/templates/compose.env.j2
     COMPOSE_KOMODO_IMAGE_TAG=latest
     COMPOSE_KOMODO_BACKUPS_PATH={{ komodo_backups_dir }}
     KOMODO_DB_USERNAME={{ komodo_db_username }}
     KOMODO_DB_PASSWORD={{ komodo_db_password }}
     KOMODO_DATABASE_ADDRESS=ferretdb:27017
     KOMODO_DATABASE_USERNAME={{ komodo_db_username }}
     KOMODO_DATABASE_PASSWORD={{ komodo_db_password }}
     KOMODO_PASSKEY={{ komodo_passkey }}
     KOMODO_HOST={{ komodo_host }}
     KOMODO_TITLE={{ komodo_title }}
     KOMODO_FIRST_SERVER={{ komodo_first_server }}
     KOMODO_FIRST_SERVER_NAME={{ komodo_first_server_name }}
     KOMODO_MONITORING_INTERVAL={{ komodo_monitoring_interval }}
     KOMODO_RESOURCE_POLL_INTERVAL={{ komodo_resource_poll_interval }}
     KOMODO_LOCAL_AUTH=true
     KOMODO_INIT_ADMIN_USERNAME={{ komodo_admin_username }}
     KOMODO_INIT_ADMIN_PASSWORD={{ komodo_admin_password }}
     KOMODO_DISABLE_USER_REGISTRATION=true
     KOMODO_ENABLE_NEW_USERS=false
     PERIPHERY_PASSKEYS={{ komodo_passkey }}
     PERIPHERY_SSL_ENABLED=true
     PERIPHERY_ROOT_DIRECTORY=/etc/komodo
     PERIPHERY_INCLUDE_DISK_MOUNTS=/etc/hostname
     TZ=America/Phoenix

  5. ansible/roles/komodo-periphery/defaults/main.yml
     - komodo_periphery_image: ghcr.io/moghtech/komodo-periphery:latest
     - komodo_periphery_container_name: komodo-periphery
     - komodo_periphery_port: 8120
     - komodo_periphery_root_dir: /etc/komodo
     - komodo_passkey: "{{ vault_komodo_passkey }}"

  6. ansible/roles/komodo-periphery/tasks/main.yml
     All tasks use ansible.builtin.raw (Unraid has no Python).
     - docker stop komodo-periphery || true
     - docker rm komodo-periphery || true
     - docker pull {{ komodo_periphery_image }}
     - docker run -d --name {{ komodo_periphery_container_name }} --restart unless-stopped
         -p {{ komodo_periphery_port }}:8120
         -v /var/run/docker.sock:/var/run/docker.sock
         -v /proc:/proc
         -v {{ komodo_periphery_root_dir }}:{{ komodo_periphery_root_dir }}
         -e PERIPHERY_PASSKEYS={{ komodo_passkey }}
         -e PERIPHERY_SSL_ENABLED=true
         -e PERIPHERY_ROOT_DIRECTORY={{ komodo_periphery_root_dir }}
         -e PERIPHERY_INCLUDE_DISK_MOUNTS=/etc/hostname
         {{ komodo_periphery_image }}
     - Health check: docker ps --filter name=komodo-periphery --filter status=running -q (non-empty)
     - Show last 10 lines of container logs

  7. ansible/playbooks/platform/deploy-komodo.yml
     Two plays:
     - Play 1: hosts: komodo-lxc, gather_facts: true, roles: [komodo-core]
     - Play 2: hosts: unraid-server, gather_facts: false, roles: [komodo-periphery]

  8. ansible/group_vars/komodo/komodo.yml
     ansible_user: root
     ansible_ssh_private_key_file: ~/.ssh/id_ed25519_homelab
     (Reference comment: add vault_komodo_* vars to group_vars/komodo/vault.yml encrypted with ansible-vault)

suggested_approach: |
  Follow the pattern in roles/chiffon-executor/tasks/main.yml for Unraid raw tasks.
  For the LXC (komodo-lxc), use ansible.builtin modules since it has Python — copy
  pattern from roles/gitea/tasks/main.yml (which also uses raw for Unraid but shows
  the docker compose up pattern).

  The komodo-core role uses a two-file approach: docker-compose.yml.j2 + compose.env.j2.
  All secrets flow through compose.env, never inline in docker-compose.yml.

  Do NOT generate group_vars/*/vault.yml — those are encrypted and managed separately.
  Generate complete, deployment-ready YAML for every file. No placeholders.

  Output each file as a distinct ## Code block section with the filename as the header.

applicable_skills:
  - yaml-validation

edits: []
verify: []

scope:
  allowed_write_globs:
    - ansible/roles/komodo-core/**
    - ansible/roles/komodo-periphery/**
    - ansible/playbooks/platform/deploy-komodo.yml
    - ansible/group_vars/komodo/**

constraints:
  max_files_changed: 15
  max_diff_bytes: 100000
  timeout_seconds: 600
