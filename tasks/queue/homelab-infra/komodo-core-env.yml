id: komodo-core-env
goal: Generate ansible/roles/komodo-core/templates/compose.env.j2 with all Komodo environment variables
source: obsidian:projects/homelab-infra/komodo-deployment
gitea_issue: 16

description: |
  Generate the compose.env Jinja2 template for the komodo-core Ansible role.
  Target repo: homelab-infra/ansible.

  File to generate: ansible/roles/komodo-core/templates/compose.env.j2

  All variables reference Ansible role vars ({{ var_name }} syntax):

  COMPOSE_KOMODO_IMAGE_TAG=latest
  COMPOSE_KOMODO_BACKUPS_PATH={{ komodo_backups_dir }}

  # Database
  POSTGRES_USER={{ komodo_db_username }}
  POSTGRES_PASSWORD={{ komodo_db_password }}
  POSTGRES_DB=komodo
  FERRETDB_POSTGRESQL_URL=postgresql://{{ komodo_db_username }}:{{ komodo_db_password }}@postgres:5432/komodo

  # Komodo core config
  KOMODO_DB_USERNAME={{ komodo_db_username }}
  KOMODO_DB_PASSWORD={{ komodo_db_password }}
  KOMODO_DATABASE_ADDRESS=ferretdb:27017
  KOMODO_DATABASE_USERNAME={{ komodo_db_username }}
  KOMODO_DATABASE_PASSWORD={{ komodo_db_password }}
  KOMODO_PASSKEY={{ komodo_passkey }}
  KOMODO_HOST={{ komodo_host }}
  KOMODO_TITLE={{ komodo_title }}
  KOMODO_FIRST_SERVER={{ komodo_first_server }}
  KOMODO_FIRST_SERVER_NAME={{ komodo_first_server_name }}
  KOMODO_MONITORING_INTERVAL={{ komodo_monitoring_interval }}
  KOMODO_RESOURCE_POLL_INTERVAL={{ komodo_resource_poll_interval }}
  KOMODO_LOCAL_AUTH=true
  KOMODO_INIT_ADMIN_USERNAME={{ komodo_admin_username }}
  KOMODO_INIT_ADMIN_PASSWORD={{ komodo_admin_password }}
  KOMODO_DISABLE_USER_REGISTRATION=true
  KOMODO_ENABLE_NEW_USERS=false

  # Periphery (shared passkey, used if periphery also runs here â€” none on this host but keep for compat)
  PERIPHERY_PASSKEYS={{ komodo_passkey }}
  PERIPHERY_SSL_ENABLED=true
  PERIPHERY_ROOT_DIRECTORY=/etc/komodo
  PERIPHERY_INCLUDE_DISK_MOUNTS=/etc/hostname

  TZ=America/Phoenix

scope:
  allowed_write_globs:
    - ansible/roles/komodo-core/templates/compose.env.j2

constraints:
  max_files_changed: 1
  timeout_seconds: 120

edits: []
verify: []
